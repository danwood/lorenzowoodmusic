extends ../_layout.pug

block prelude
	|<?php
	|
	|require_once('../classes/downcode.php');
	|$db = new DowncodeDB();
	|$slug = isset($_GET['slug']) ? trim($_GET['slug']) : '';
	|
	|if (empty($slug)) {
	|   $albums = $db->allAlbums();
	|   foreach ($albums as $album) {
	|       echo '<a href="' . htmlentities($album['slug'], ENT_QUOTES) . '">';
	|       echo htmlspecialchars($album['title']);
	|       echo '</a><br />' . PHP_EOL;
	|   }
	|   die();
	|}
	|
	|$now = new DateTime();
	|$release = $now;   // default to now, so it should show up as released
	|$album = $db->albumForSlug($slug);
	|if (!$album) {
	|   header('HTTP/1.0 404 Not Found');
	|   readfile('../404.html');
	|   exit();
	|}
	|
	|$longTitle = $album['title'];
	|$explicit = $album['explicit'] == 'true' || $album['explicit'] == 1;
	|if (!empty($album['featuring'])) { $longTitle .= ' [feat. ' . $album['featuring'] . ']'; }
	|$longTitle .= ' - by ' . $album['artist'];
	|$releaseDateString = NULL;
	|if (!empty($album['release_date'])) {
	|    $release = new DateTime($album['release_date'], new DateTimeZone('America/New_York'));
	|    $now = new DateTime();
	|    if ($now < $release) $releaseDateString = $release->format('l, F jS');
	|}
	|?>




block vars
	- var currentClass = link-page
	//- do not define pageTitle; it breaks things (?) and isn't need since title is generated from database

block append links
	link(rel="prefetch" href="//img.youtube.com")
		//- This should be done on any page showing YOUTUBE VIDEOS

block title
	<title><?php echo htmlentities($longTitle); ?></title>

block description
	<meta name='description' content='<?php echo htmlentities($longTitle, ENT_QUOTES); ?>'>

block append logo
	.mini-icons
		a(data-title="Instagram" href="https://instagram.com/LorenzoWoodMusic" style="fill:#e95950")
			include ../svg/instagram-logo.svg
		a(data-title="Facebook" href="https://facebook.com/LorenzoWoodMusic" style="fill:#3b5998")
			include ../svg/facebook-logo.svg
	
block footer-icons

block append links

	//- only do the metadata if we have a single album
	//- FB OG tags
	<meta property='og:title' content='<?php echo htmlentities($longTitle, ENT_QUOTES); ?>'>
	<meta property='og:description' content='Preview, download or stream <?php echo htmlentities($longTitle, ENT_QUOTES); ?>'>
	<meta property='og:url' content='<?php echo htmlentities(curPageURL()); ?>'>
	<meta property='og:type' content='article'>
	<meta property='og:image' content='<?php echo baseURL() . '/album_art_1200x630/' . htmlentities($album['imageName'], ENT_QUOTES); ?>'> 
	//- 600 x 315 ideally 1200x630
	//- additional media
	//- Twitter summary card meta tags
	<meta name='twitter:url' value='<?php echo htmlentities(curPageURL()); ?>'>
	<meta name='twitter:title' content='<?php echo htmlentities($longTitle, ENT_QUOTES); ?>'>
	<meta name='twitter:description' content='Preview, download or stream <?php echo htmlentities($longTitle, ENT_QUOTES); ?>'>
	<meta name='twitter:card' content='summary_large_image'>
	<meta name='twitter:image' content='<?php echo baseURL() . '/album_art_1200x630/' . htmlentities($album['imageName'], ENT_QUOTES); ?>'>
	//- square 144 up to 4000, 5 MB max

block append styles
	link(rel='stylesheet', href='/css/linkstyles.042223.css')


block main

	.background-blur
		//- use the exact same image as the displayed one so we don't need another image loaded
		<img src="<?php echo ( $album['separate_blurred_image'] ? '../blurred_100/' : '../album_art_640/') . htmlentities($album['imageName'], ENT_QUOTES); ?>" alt="<?php echo htmlentities($album['title'], ENT_QUOTES); ?>">

	.center-column

		<?php if ($album['additional_info']) { ?>
		
		<div class="centered additional"><a href="<?php echo htmlentities($album['additional_info_url'], ENT_QUOTES); ?>"><?php echo htmlspecialchars($album['additional_info']); ?></a></div>

		<?php } ?>

		.imagecontainer
			<img src="../album_art_640/<?php echo htmlentities($album['imageName'], ENT_QUOTES); ?>" alt="<?php echo htmlentities($album['title'], ENT_QUOTES); ?>">

		.title-container
			
			<?php if ($album['youtube_video_id']) { ?>
			<div class="youtube-border"><div class="youtube" data-linking="yep" data-code='<?php echo htmlentities($album['youtube_video_id'], ENT_QUOTES); ?>' data-title=''></div></div>
			<?php } ?>


			h1
				| <?php echo htmlspecialchars($album['artist']); ?> 
				br
				|  <?php echo htmlspecialchars($album['title']); ?>
			<?php $featuring = $album['featuring']; if (!empty($featuring)) { echo ' (Featuring ' . htmlspecialchars($featuring) . ')'; } ?>

		.title-container
			p.
				<?php
				if ($now < $release) {
					echo 'Releasing ' . htmlspecialchars($releaseDateString);
				} else {
					echo 'Download and stream now';
				} ?>
			//- The Javascript slide-switch to change between explicit and radio-edit versions.
			div.requires-js.
				<?php
				if ($album['explicit_or_clean_slug']) { ?>
				<div class="switch">
					<input type="radio" class="switch-input" name="view2" value="dirty" id="dirty" <?php if ($explicit) { echo 'checked'; } ?>>
					<label for="dirty" class="switch-label switch-label-off"
					<?php
					if (!$explicit) {
						echo 'onclick="window.location=\'https://www.lorenzowoodmusic.com/link/' 
							. htmlentities($album['explicit_or_clean_slug'], ENT_QUOTES) 
							. '\'"'; 
					} ?>
					>Explicit</label>
					<input type="radio" class="switch-input" name="view2" value="clean" id="clean"  <?php if (!$explicit) { echo 'checked'; } ?>>
					<label for="clean" class="switch-label switch-label-on"
					<?php
					if ($explicit) {
						echo 'onclick="window.location=\'https://www.lorenzowoodmusic.com/link/' 
							. htmlentities($album['explicit_or_clean_slug'], ENT_QUOTES) 
							. '\'"'; 
					} ?>
					>Radio Edit</label>
					<span class="switch-selection"></span>
				</div>
				<?php } ?>

			//- The NON-Javascript slide-switch to change between explicit and radio-edit versions.
			div.js-hidden.
				<?php
				if ($album['explicit_or_clean_slug']) { ?>
					<?php
					if (!$explicit) {
						echo "<a href='https://www.lorenzowoodmusic.com/link/"
							. htmlentities($album['explicit_or_clean_slug'], ENT_QUOTES) 
							. "'>"; 
					}
					else {
						echo '<b>';
					}
					echo 'Explicit';
					if (!$explicit) {
						echo "</a>";
					}
					else {
						echo '</b>';
					}


					echo ' &middot; ';

					if ($explicit) {
						echo "<a href='https://www.lorenzowoodmusic.com/link/"
							. htmlentities($album['explicit_or_clean_slug'], ENT_QUOTES) 
							. "'>"; 
					}
					else {
						echo '<b>';
					}
					echo 'Radio Edit';
					if ($explicit) {
						echo "</a>";
					}
					else {
						echo '</b>';
					}
				} ?>

			
					
		.service-container

			<?php if ($album['itunes_album']) { ?>
			
			<div class="service"><a href="https://geo.itunes.apple.com/us/album/<?php echo htmlentities($album['itunes_album'], ENT_QUOTES); ?>?app=itunes&amp;at=1000lKSp"><img src="../svg/iTunes_Store_Buy_Lockup_RGB_blk.svg" alt="iTunes"><span class="play"><?php echo ($now < $release) ? 'Pre-order' : 'Download'; ?></span></a></div>

			<?php } if ($album['itunes_album'] && ($now >= $release)) { ?>

			<div class="service"><a href="https://geo.itunes.apple.com/us/album/<?php echo htmlentities($album['itunes_album'], ENT_QUOTES); ?>?mt=1&app=music&amp;at=1000lKSp"><img src="../svg/Apple_Music_lockup_RGB_blk.svg" alt="Apple Music"><span class="play">Play</span></a></div>

			//- We will only have the spotify link if the song has been released, unless things change...

			<?php } if ($album['spotify_track']) { ?>
			
			<div class="service"><a href="https://play.spotify.com/track/<?php echo htmlentities($album['spotify_track'], ENT_QUOTES); ?>"><img src="../svg/spotify-text.svg" alt="Spotify"><span class="play">Play</span></a></div>

			//- Use spotify ALBUM link only if we don't have a TRACK specified.
			<?php } if ($album['spotify_album'] && !$album['spotify_track']) { ?>
			
			<div class="service"><a href="https://play.spotify.com/album/<?php echo htmlentities($album['spotify_album'], ENT_QUOTES); ?>"><img src="../svg/spotify-text.svg" alt="Spotify"><span class="play">Play</span></a></div>

			//- Show the spotify presave link if we don't have a real spotify link. Spotify might be slow in taking the release live,
			//- or maybe we were slow in putting the link into our database.

			<?php } if ( (!$album['spotify_album']) && (!$album['spotify_track']) &&$album['spotify_presave_url']) { ?>
			
			<div class="service"><a rel="nofollow" href="<?php echo htmlentities($album['spotify_presave_url'], ENT_QUOTES); ?>"><img src="../svg/spotify-text.svg" alt="Presave on Spotify"><span class="play">Pre-save</span></a>

			<div style="padding-left:5em; font-size:80%; color:gray">
			|<?php if ($now >= $release) { ?>
			|<div><b>Direct spotify link coming soon!</b></div>
			|<?php } ?>
			|This step takes you to our DistroKid.com page to continue. You will be asked to log into your Spotify account.</div>

			<?php } if ($album['google_play_album']) { ?>
			
			<div class="service"><a href="https://play.google.com/store/music/album/<?php echo htmlentities($album['google_play_album'], ENT_QUOTES); ?>"><img src="../svg/google-play.svg" alt="Google Play"><span class="play"><?php echo ($now < $release) ? 'Pre-order' : 'Download'; ?></span></a></div>




			<?php } if ($now >= $release) { ?>


			<?php      if ($album['amazon_dp']) { ?>
			
			<div class="service"><a href="https://www.amazon.com/dp/<?php echo htmlentities($album['amazon_dp'], ENT_QUOTES); ?>"><img src="../svg/amazon-music.svg" alt="Amazon Music"><span class="play">Play</span></a></div>

			<?php } if ($album['youtube_music_v']) { ?>
			
			<div class="service"><a href="https://music.youtube.com/watch?v=<?php echo htmlentities($album['youtube_music_v'], ENT_QUOTES); ?>"><img src="../svg/youtube-music.svg" alt="Youtube Music"><span class="play">Play</span></a></div>

			//- Use YouTube Music ALBUM (MPREb...) link only if we don't have a TRACK specified.

			<?php } if ($album['youtube_music_MPRE'] && !$album['youtube_music_v']) { ?>
			
			<div class="service"><a href="https://music.youtube.com/browse/<?php echo htmlentities($album['youtube_music_MPRE'], ENT_QUOTES); ?>"><img src="../svg/youtube-music.svg" alt="Youtube Music"><span class="play">Play</span></a></div>




			<?php } if ($album['bandcamp']) { ?>
			
			<div class="service"><a href="https://lorenzowoodmusic.bandcamp.com/<?php echo htmlentities($album['bandcamp'], ENT_QUOTES); ?>"><img src="../svg/bandcamp.svg" alt="Bandcamp"><span class="play">Download</span></a>

			<?php if ($album['bandcamp_additional_info_url']) { ?>

			<div style="padding-left:5em; margin-top:-20px; font-size:80%;"><a style="text-decoration:underline !important" href="<?php echo htmlentities($album['bandcamp_additional_info_url'], ENT_QUOTES); ?>"><?php echo htmlspecialchars($album['bandcamp_additional_info']); ?></a></div>
			<?php } ?>
			</div>

			<?php } if ($album['soundcloud_path']) { ?>
			
			<div class="service"><a href="https://soundcloud.com/<?php echo htmlentities($album['soundcloud_path'], ENT_QUOTES); ?>"><img src="../svg/soundcloud.svg" alt="Soundcloud"><span class="play">Play</span></a></div>

			<?php } if ($album['deezer_track']) { ?>
			
			<div class="service"><a href="https://www.deezer.com/us/track/<?php echo htmlentities($album['deezer_track'], ENT_QUOTES); ?>"><img src="../svg/deezer.svg" alt="Deezer"><span class="play">Play</span></a></div>

			//- Use deezer ALBUM link only if we don't have a TRACK specified.

			<?php } if ($album['deezer_album'] && !$album['deezer_track']) { ?>
			
			<div class="service"><a href="https://www.deezer.com/us/album/<?php echo htmlentities($album['deezer_album'], ENT_QUOTES); ?>"><img src="../svg/deezer.svg" alt="Deezer"><span class="play">Play</span></a></div>


			<?php } if ($album['iheartradio_songs']) { ?>
			
			<div class="service"><a href="https://www.iheart.com/artist/lorenzo-wood-32159981/songs/<?php echo htmlentities($album['iheartradio_songs'], ENT_QUOTES); ?>"><img src="../svg/iheartradio-logo.svg" alt="IHeartRadio"><span class="play">Play</span></a></div>

			<?php } if ($album['tidal_track']) { ?>
			
			<div class="service"><a href="https://listen.tidal.com/track/<?php echo htmlentities($album['tidal_track'], ENT_QUOTES); ?>"><img src="../svg/tidal.svg" alt="Tidal"><span class="play">Play</span></a></div>

			//- Use tidal ALBUM link only if we don't have a TRACK specified.

			<?php } if ($album['tidal_album'] && !$album['tidal_track']) { ?>
			
			<div class="service"><a href="https://listen.tidal.com/album/<?php echo htmlentities($album['tidal_album'], ENT_QUOTES); ?>"><img src="../svg/tidal.svg" alt="Tidal"><span class="play">Play</span></a></div>






			<?php } if ($album['cd_url']) { ?>
			
			<div class="service"><a href="<?php echo htmlentities($album['cd_url'], ENT_QUOTES); ?>"><img src="/img/cd100.png" alt="Buy CD"><span class="play">Buy</span></a></div>

			<?php } ?>

			<?php } ?>

block prepend scripts
	script
		include ../js/youtube-min.js
	|<?php
	|$db->close();
	|?>